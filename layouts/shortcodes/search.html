{{/*
  search.html - Hugo Shortcode for search using searchjs library
*/}}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.0.0/fuse.min.js"></script>
<style>
.search-hasil {
  position: absolute;
  background-color: #fff;
  border: 1px solid #ccc;
  max-height: 300px;
  overflow-y: auto;
  width: 100%;
  display: none;
  z-index: 9999;
}

.search-hasil a {
  display: block;
  padding: 10px;
  text-decoration: none;
  color: #333;
}

.search-hasil a:hover {
  background-color: #f4f4f4;
}
</style>

<script>
$(document).ready(function() {
  var searchInput = $('#search-enter');
  var searchResults = $('#search-hasil');

  // Function to fetch the movies metadata
  function fetchMoviesMetadata() {
    var moviesMetadata = [];
    {{ range (where .Site.Pages "Section" "movies") }}
      moviesMetadata.push({
        title: '{{ .Title }}',
        link: '{{ .Permalink }}',
        content: '{{ .Content }}'
      });
    {{ end }}
    return moviesMetadata;
  }

  // Create Fuse object with options
  var fuseOptions = {
    keys: ['title', 'content'],
    includeMatches: true,
    includeScore: true,
    threshold: 0.2,
  };
  
  var moviesMetadata = fetchMoviesMetadata();

  // Create Fuse object with movies metadata
  var fuse = new Fuse(moviesMetadata, fuseOptions);

  // Function to handle input change event
  searchInput.on('input', function() {
    var searchQuery = $(this).val();
    var searchResultsHTML = '';

    if (searchQuery.length >= 3) {
      var results = fuse.search(searchQuery);

      if (results.length > 0) {
        results.forEach(function(result) {
          if (result.score <= 0.4) {
            var highlightedTitle = result.item.title;
            result.matches.forEach(function(match) {
              if (match.key !== 'title') {
                var regex = new RegExp('\\b' + match.value + '\\b', 'gi');
                highlightedTitle = highlightedTitle.replace(regex, '<strong>$&</strong>');
              }
            });
            searchResultsHTML += '<a href="' + result.item.link + '">' + highlightedTitle + '</a>';
          }
        });
      } else {
        searchResultsHTML = '<p>No results found.</p>';
      }
    } else {
      searchResultsHTML = '<p>Please enter at least 3 characters.</p>';
    }

    searchResults.html(searchResultsHTML);
    
    if (searchQuery.length >= 3) {
      searchResults.show();
    } else {
      searchResults.hide();
    }
  });

  // Function to handle input focusout event
  searchInput.on('focusout', function() {
    setTimeout(function() {
      searchResults.hide();
    }, 100);
  });

  // Function to handle search result link click event
  searchResults.on('click', 'a', function(e) {
    e.stopPropagation();
    var link = $(this).attr('href');
    window.location = link;
  });
});
</script>

<input id="search-enter" type="text" placeholder="Search...">
<div id="search-hasil" class="search-hasil"></div>