<script src="https://cdn.jsdelivr.net/npm/fuse.js@3.6.1/dist/fuse.min.js"></script>

{{- $shortcodeID := (now.UnixNano | printf "%x") -}}
{{- $resultID := printf "search-result-%s" $shortcodeID -}}
{{- $inputID := printf "search-input-%s" $shortcodeID -}}

<div id="{{ $resultID }}">{{ if .IsInnerHTML }}{{ else }}No results found{{ end }}</div>
<input id="{{ $inputID }}" type="text" placeholder="Search..." oninput="search{{ $shortcodeID }}()" />

<script>
  function search{{ $shortcodeID }}() {
    const fuseOptions = {
      shouldSort: true,
      threshold: 0.3,
      location: 0,
      distance: 100,
      maxPatternLength: 32,
      minMatchCharLength: 1,
      keys: ["title", "content"],
    };

    const input = document.getElementById("{{ $inputID }}");
    const resultContainer = document.getElementById("{{ $resultID }}");

    const fuse = new Fuse({{ .Site.Pages | jsonify }}, fuseOptions);

    input.addEventListener("input", function () {
      const searchQuery = input.value;
      const results = fuse.search(searchQuery);

      let htmlOutput = "";
      results.forEach(function (result) {
        const { ref, item } = result;
        const { title, permalink } = item;

        htmlOutput += `<p><a href="${permalink}">${title}</a></p>`;
      });

      resultContainer.innerHTML = htmlOutput.length > 0 ? htmlOutput : "No results found";
    });
  }
</script>